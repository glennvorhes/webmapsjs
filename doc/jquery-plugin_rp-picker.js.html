<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: jquery-plugin/rp-picker.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: jquery-plugin/rp-picker.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import $ from '../jquery';
import quickMap from '../olHelpers/quickMap';
import quickMapMulti from '../olHelpers/quickMapMulti';
import SortedFeatures from '../olHelpers/SortedFeatures';
import LayerBaseVectorGeoJson from '../layers/LayerBaseVectorGeoJson';
import LayerEsriMapServer from '../layers/LayerEsriMapServer';
import provide from '../util/provide';
const ol = require('../ol/ol');
const nm = provide('ssa');

/**
 * @callback rpSetCallback
 * @param {string} rpId
 * @param rpFeature
 */


/**
 * take the verbose string and turn it into a padded 00 and direction hwy
 * @param {string} inputString the input string
 * @returns {string} converted highway string
 */
function highwayConvert(inputString) {
    "use strict";
    inputString = inputString.trim();
    let numMatch = inputString.match(/\d+/);

    if (numMatch.length == 0) {
        throw "highway id can't be parsed " + inputString;
    }

    let hwy = numMatch[0];

    //leading Pad
    while (hwy.length &lt; 3) {
        hwy = '0' + hwy;
    }

    let dirMatch = inputString.match(/[SNEW]B$/);

    if (dirMatch.length == 0) {
        throw "highway id can't be parsed " + inputString;
    }

    return hwy + dirMatch[0][0];
}

class RpPicker {

    /**
     * constructor for the date range
     * @param {jQuery} jQueryRef reference to the jquery element
     * @param {string} url the rp service url
     */
    constructor(jQueryRef, url) {

        this._rpUrl = url;
        this._$container = jQueryRef;
        this._parentId = this._$container[0].id;
        this._mapDivId = this._parentId + '-map';
        this._mapContainerId = this._parentId + '-map-container';
        this._$container.addClass('rp-picker-container');

        this._rpSetCallback = function (rpId, rpFeature) {
        };

        /**
         *
         * @type {Array&lt;RpPicker>}
         * @private
         */
        this._otherPickerArray = [];

        /**
         *
         * @type {Map}
         * @private
         */
        this._pickerMap = undefined;

        /**
         * @type MapMoveCls
         * @private
         */
        this._pickerMapMove = undefined;

        /**
         * @type MapPopupCls
         * @private
         */
        this._pickerMapPopup = undefined;

        /**
         *
         * @type {Array&lt;number>}
         * @private
         */
        this._extent = [];

        /**
         *
         * @type {boolean}
         * @private
         */
        this._visible = false;

        /**
         *
         * @type {boolean}
         * @private
         */
        this._enabled = false;

        /**
         * @type {string}
         * @private
         */
        this._referencePointId = undefined;
        //this._referencePointFeature = undefined;

        /**
         *
         * @type {LayerBaseVectorGeoJson}
         * @private
         */
        this._rpLayer = new LayerBaseVectorGeoJson('',
            {
                minZoom: 7,
                mapMoveObj: this._pickerMapMove,
                name: 'Reference Points',
                transform: {dataProjection: 'EPSG:3857', featureProjection: 'EPSG:3857'},
                style: new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 7,
                        fill: new ol.style.Fill({color: 'rgba(0, 0, 255, 0.5)'}),
                        stroke: new ol.style.Stroke({color: 'blue', width: 2})
                    })
                })
            }
        );

        this._rpSelectionLayer = new ol.layer.Vector({
            source: new ol.source.Vector(),
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 8,
                    fill: new ol.style.Fill({color: 'rgba(255, 0, 0, 0.7)'}),
                    stroke: new ol.style.Stroke({color: 'red', width: 2})
                })
            })
        });

        this._rpOtherLayer = new ol.layer.Vector({
            source: new ol.source.Vector(),
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 8,
                    fill: new ol.style.Fill({color: 'rgba(0, 255, 0, 0.7)'}),
                    stroke: new ol.style.Stroke({color: 'green', width: 2})
                })
            })
        });

        this._rpOtherFeature = undefined;

        /**
         *
         * @type {SortedFeatures|null}
         * @private
         */
        this._sortedFeatures = null;

        let pickerHtml = `&lt;div title="Reference Point Picker" class="rp-picker-static">&lt;select disabled="disabled" >&lt;/select>&lt;/div>` +
            `&lt;div id="${this._mapContainerId}" class="rp-popup-container">` +
            '&lt;div class="rp-picker-container-top">' +
            `&lt;button class="container-head-close-button container-head-button">Close&lt;/button>` +
            `&lt;button class="container-head-clear-button container-head-button">Clear&lt;/button>` +
            `&lt;span class="container-head-rp-id container-head-span">&lt;/span>` +
            `&lt;span class="container-head-coordinates container-head-span">&lt;/span>` +
            '&lt;/div>' +
            `&lt;div id="${this._mapDivId}" class="rp-picker-map">&lt;/div>` +
            `&lt;/div>` +
            '';

        this._$container.append(pickerHtml);
        this._$rpSelect = this._$container.find('select');
        let $selectorDiv = this._$container.find('.rp-picker-static');

        this._$mapContainer = this._$container.find('#' + this._mapContainerId);
        this._$closeButton = this._$container.find('.container-head-close-button');
        this._$clearButton = this._$container.find('.container-head-clear-button');
        this._$containerHeadRpId = this._$container.find('.container-head-rp-id');
        this._$containerHeadCoordinates = this._$container.find('.container-head-coordinates');

        this._$clearButton.click(() => {
            this.referencePointId = undefined;
        });

        this._$rpSelect.click((evt) => {
            this._closeOtherPickers();
            $selectorDiv.trigger('click');
            $selectorDiv.trigger('click');
            evt.stopPropagation();
        });

        this._$rpSelect.change(() => {
            this.referencePointId = this._$rpSelect.val();
        }).keyup(() => {
            if (this.referencePointId != this._$rpSelect.val()){
                this._$rpSelect.trigger('change');
            }
        });

        // open the map container
        $selectorDiv.click(() => {
            if (!this._enabled) {
                return;
            }

            //if (this.visible) {
            //    this.visible = false;
            //    return;
            //}

            this.visible = true;

            // initialize on first show
            if (!this._pickerMap) {
                this._mapInit();
            }
        });

        this._$closeButton.click((evt) => {
            this.visible = false;
            evt.stopPropagation();
        });
    }

    /**
     *
     * @private
     */
    _mapInit() {
        let multiMap = quickMapMulti({
            divId: this._mapDivId,
            minZoom: 6,
            zoom: 6,
            baseSwitcher: false
        });

        this._pickerMap = multiMap.map;
        this._pickerMapMove = multiMap.mapMove;
        this._pickerMapPopup = multiMap.mapPopup;

        // add the other selected feature if it has been defined
        if (this.otherFeature) {
            this.otherFeature = this.otherFeature;
            //this._rpOtherLayer.getSource().addFeature(this.otherFeature);
        }

        let metamanagerSegments = new LayerEsriMapServer(
            'http://transportal.cee.wisc.edu/applications/arcgis2/rest/services/MetaManager/MM_All_Segments/MapServer',
            {
                minZoom: 7,
                visible: true,
                name: 'Metamanager Segments',
                opacity: 0.7
            });

        // add the layers to the map
        this._pickerMap.addLayer(metamanagerSegments.olLayer);
        this._pickerMap.addLayer(this._rpLayer.olLayer);
        this._pickerMap.addLayer(this._rpSelectionLayer);
        this._pickerMap.addLayer(this._rpOtherLayer);

        // configure the popup response function
        this._pickerMapPopup.addVectorPopup(this._rpLayer, function (props) {
            return `&lt;input type="button" id='${props['rpId']}' class="select-rp-btn" value="Select"/>&amp;nbsp;` + props['rpId'];
        });

        // add the popup change function to find the select button
        this._pickerMapPopup.addPopupChangedFunction(() => {
            let selectButton = $('.select-rp-btn');
            if (selectButton.length > 0) {
                let _this = this;
                selectButton.click(function () {
                    _this.referencePointId = this.id;
                });
            }
        });

        this._setMapExtent();
    }


    /**
     * get the picker visibility
     * @returns {boolean} is visible
     */
    get visible() {
        return this._visible;
    }

    /**
     * set the picker visibility
     * @param {boolean} vis is visible
     */
    set visible(vis) {
        if (this.visible === vis) {
            return;
        }
        if (vis) {
            this._$mapContainer.show();
            this._closeOtherPickers();
        } else {
            this._$mapContainer.hide();
            this._pickerMapPopup.closePopup();
        }
        this._visible = vis;
    }

    /**
     *
     * @returns {Array.&lt;number>} extent array
     */
    get extent() {
        return this._extent;
    }

    /**
     *
     * @param {Array.&lt;number>} newExtent - extent array
     */
    set extent(newExtent) {
        this._extent = newExtent;
        if (this._pickerMap) {
            this._setMapExtent();
        }
    }

    _setMapExtent() {
        if (this._extent) {
            this._pickerMap.getView().fit(this._extent, this._pickerMap.getSize());
            //this._pickerMap.getView().setZoom(this._pickerMap.getView().getZoom());
        }
    }

    /**
     *
     * @returns {string|undefined} ref point id
     */
    get referencePointId() {
        return this._referencePointId;
    }

    /**
     *
     * @param {string|undefined} newRef - new ref id
     */
    set referencePointId(newRef) {

        if (newRef == this.referencePointId) {
            return;
        }

        this._referencePointId = newRef;

        this._rpSelectionLayer.getSource().clear();

        if (this.referencePointId == undefined) {
            //this._$spanTextElement.val('');
            this._$containerHeadRpId.html('');
            this._$containerHeadCoordinates.html('');
            this._rpSetCallback(this.referencePointId, undefined);
            if (this._pickerMapPopup) {
                this._pickerMapPopup.closePopup();
            }

            return;
        }

        let selectedFeature = this._sortedFeatures.getFeature(this.referencePointId);

        this._rpSelectionLayer.getSource().addFeature(selectedFeature);
        this._$rpSelect.val(this.referencePointId);
        let featureCopy = selectedFeature.clone();
        featureCopy.getGeometry().transform('EPSG:3857', 'EPSG:4326');
        let lon = featureCopy.getGeometry().getCoordinates()[0];
        let lat = featureCopy.getGeometry().getCoordinates()[1];

        this._$containerHeadRpId.html(this.referencePointId);
        this._$containerHeadCoordinates.html(`${lat.toFixed(5)}, ${lon.toFixed(5)}`);
        this._rpSetCallback(this.referencePointId, selectedFeature);
    }

    get otherFeature() {
        return this._rpOtherFeature;
    }

    set otherFeature(otherFeature) {
        this._rpOtherFeature = otherFeature;

        if (this._rpOtherLayer) {
            this._rpOtherLayer.getSource().clear();
            if (otherFeature) {
                this._rpOtherLayer.getSource().addFeature(otherFeature);
            }
        }
    }

    /**
     *
     * @param {rpSetCallback} newCallback - new callback function
     */
    set rpSetCallback(newCallback) {
        this._rpSetCallback = newCallback;
    }

    /**
     *
     * @param {RpPicker} otherPicker - the other picker in the group
     */
    addOtherPicker(otherPicker) {
        this._otherPickerArray.push(otherPicker);
    }

    _closeOtherPickers() {
        for (let p of this._otherPickerArray) {
            p.visible = false;
        }
    }

    /**
     *
     * @returns {boolean} if eneabled
     * @private
     */
    get enabled() {
        return this._enabled;
    }

    /**
     *
     * @param {boolean} isEnabled - if enabled
     * @private
     */
    set enabled(isEnabled) {
        this._enabled = isEnabled;
        this._$rpSelect.prop('disabled', !this._enabled);

        if (!this._enabled) {
            this.visible = false;
        }
    }

    /**
     *
     * @param {string} county - the county
     * @param {string} highway - the highway
     * @param {string} [rp=undefined] - the reference point
     */
    setCountyAndHighway(county, highway, rp) {

        highway = highwayConvert(highway);

        $.get(this._rpUrl, {'county': county, 'highway': highway}, (d) => {
            /**
             * @type Array&lt;object>
             */
            this._rpLayer.addFeatures(d);
            this._sortedFeatures = new SortedFeatures(this._rpLayer.source.getFeatures(), 'rpId');

            let rpArray = [];
            this._$rpSelect.html('');

            for (let f of this._sortedFeatures.sortedFeatures) {
                let rpId = f.getProperties()['rpId'];
                if (rpArray.indexOf(rpId) &lt; 0) {
                    rpArray.push(rpId);
                    this._$rpSelect.append(`&lt;option>${rpId}&lt;/option>`);
                }
            }
            this.enabled = true;
            this.extent = this._rpLayer.source.getExtent();
            if (rp){
                this.referencePointId = rp;
            }
        }, 'json');
    }

    clear(){
        this.referencePointId = undefined;
        this._$rpSelect.html('');
        this._rpLayer.clear();
        this.enabled = false;
    }
}

nm.RpPicker = RpPicker;

/**
 * Adds rp picker
 * @param {string} serviceUrl url for the points
 * @returns {RpPicker} a reference picker
 */
$.fn.rpPicker = function (serviceUrl) {
    return new RpPicker(this, serviceUrl);
};

export default undefined;

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="-_FeatureLayerProperties.html">_FeatureLayerProperties</a></li><li><a href="-_Slider.html">_Slider</a></li><li><a href="CommonSymbol.html">CommonSymbol</a></li><li><a href="Corridor.html">Corridor</a></li><li><a href="DayRange.html">DayRange</a></li><li><a href="ItsLayerCollection.html">ItsLayerCollection</a></li><li><a href="LayerBase.html">LayerBase</a></li><li><a href="LayerBaseVector.html">LayerBaseVector</a></li><li><a href="LayerBaseVectorEsri.html">LayerBaseVectorEsri</a></li><li><a href="LayerBaseVectorGeoJson.html">LayerBaseVectorGeoJson</a></li><li><a href="LayerBaseXyzTile.html">LayerBaseXyzTile</a></li><li><a href="LayerEsriMapServer.html">LayerEsriMapServer</a></li><li><a href="LayerGroup.html">LayerGroup</a></li><li><a href="LayerItsInventory.html">LayerItsInventory</a></li><li><a href="LayerLegend.html">LayerLegend</a></li><li><a href="LayerRealEarthTile.html">LayerRealEarthTile</a></li><li><a href="LayerVectorRealEarth.html">LayerVectorRealEarth</a></li><li><a href="MapInteractionBase.html">MapInteractionBase</a></li><li><a href="MapMoveCls.html">MapMoveCls</a></li><li><a href="MapPopupCls.html">MapPopupCls</a></li><li><a href="RealEarthAnimate.html">RealEarthAnimate</a></li><li><a href="RealEarthAnimateTile.html">RealEarthAnimateTile</a></li><li><a href="RealEarthAnimateVector.html">RealEarthAnimateVector</a></li><li><a href="RpPicker.html">RpPicker</a></li><li><a href="SingleSymbol.html">SingleSymbol</a></li><li><a href="Sliders.html">Sliders</a></li><li><a href="SortedFeatures.html">SortedFeatures</a></li><li><a href="SsaCorridorPicker.html">SsaCorridorPicker</a></li><li><a href="UniqueValueSymbol.html">UniqueValueSymbol</a></li></ul><h3>Global</h3><ul><li><a href="global.html#$">$</a></li><li><a href="global.html#bundleEs2015Multiple">bundleEs2015Multiple</a></li><li><a href="global.html#dateToYyyyMmDdHh000">dateToYyyyMmDdHh000</a></li><li><a href="global.html#dateToYyyyMmDdHhMmSs">dateToYyyyMmDdHhMmSs</a></li><li><a href="global.html#definedAndNotNull">definedAndNotNull</a></li><li><a href="global.html#defineLegend">defineLegend</a></li><li><a href="global.html#defineStyle">defineStyle</a></li><li><a href="global.html#gulp">gulp</a></li><li><a href="global.html#hexAlphaToRgbOrRgba">hexAlphaToRgbOrRgba</a></li><li><a href="global.html#highwayConvert">highwayConvert</a></li><li><a href="global.html#htmlEscape">htmlEscape</a></li><li><a href="global.html#makeBlueGreenRedGradient">makeBlueGreenRedGradient</a></li><li><a href="global.html#makeBlueGreenRedGradientZScore">makeBlueGreenRedGradientZScore</a></li><li><a href="global.html#makeFeatureServiceLegendAndSymbol">makeFeatureServiceLegendAndSymbol</a></li><li><a href="global.html#makeGuid">makeGuid</a></li><li><a href="global.html#makeMapServiceLegend">makeMapServiceLegend</a></li><li><a href="global.html#mapServiceLegendItem">mapServiceLegendItem</a></li><li><a href="global.html#offsetMinutes">offsetMinutes</a></li><li><a href="global.html#processLessFile">processLessFile</a></li><li><a href="global.html#propertiesZoomStyle">propertiesZoomStyle</a></li><li><a href="global.html#provide">provide</a></li><li><a href="global.html#quickMap">quickMap</a></li><li><a href="global.html#quickMapBase">quickMapBase</a></li><li><a href="global.html#quickMapMulti">quickMapMulti</a></li><li><a href="global.html#resolutionToZoom">resolutionToZoom</a></li><li><a href="global.html#returnedColors">returnedColors</a></li><li><a href="global.html#rgb2hex">rgb2hex</a></li><li><a href="global.html#rgbToRgba">rgbToRgba</a></li><li><a href="global.html#undefinedOrNull">undefinedOrNull</a></li><li><a href="global.html#zoomToResolution">zoomToResolution</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Tue May 10 2016 12:18:14 GMT-0500 (Central Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
