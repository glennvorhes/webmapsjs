"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Created by gavorhes on 12/4/2015.
 */
var provide_1 = require("../util/provide");
var mapPopup_1 = require("../olHelpers/mapPopup");
var $ = require("jquery");
var nm = provide_1.default('mixin');
/**
 * The GMT offset time in minutes
 * @type {number}
 */
var offsetMinutes = (new Date()).getTimezoneOffset();
/**
 * Mixin to get the product times
 * Be sure to call getTimeInit after the mixin has been applied
 */
var RealEarthAnimate = (function () {
    function RealEarthAnimate(lyr, loadCallback) {
        this.lyr = lyr;
        this._products = lyr._products;
        if (loadCallback) {
            this.loadCallback = loadCallback;
        }
        else {
            this.loadCallback = function () { return; };
        }
    }
    /**
     * Call this after the mixin has been applied
     */
    RealEarthAnimate.prototype.timeInit = function () {
        var _this = this;
        this._rawDateStrings = [];
        this._localDates = [];
        this.localTimes = [];
        this._animateEnabled = true;
        // this._loaded = true;
        this._currentTime = undefined;
        this._currentIndex = undefined;
        $.get('http://realearth.ssec.wisc.edu/api/products', { products: this._products }, function (d) {
            if (d.length == 0) {
                console.log(_this._products + " layer not available or does not have times");
                return;
            }
            d = d[0];
            for (var i = 0; i < d['times'].length; i++) {
                _this._loadDates.call(_this, d['times'][i]);
            }
            _this.loadCallback.call(_this.lyr, _this.lyr);
            _this._loadLatest.call(_this);
        }, 'json');
    };
    /**
     * Given the raw time string, add to the arrays to keep track of dates and cache
     * @param {string} inString - input string to parse
     * @returns {string} the converted string
     * @protected
     */
    RealEarthAnimate.prototype._loadDates = function (inString) {
        var yr = inString.slice(0, 4);
        var month = inString.slice(4, 6);
        var d = inString.slice(6, 8);
        var hr = inString.slice(9, 11);
        var mn = inString.slice(11, 13);
        var sec = inString.slice(13, 15);
        var rawDateStr = inString.replace('.', '_');
        this._rawDateStrings.push(rawDateStr);
        var dteStr = month + "/" + d + "/" + yr + " " + hr + ":" + mn + ":" + sec;
        var newDte = new Date(dteStr);
        newDte.setMinutes(newDte.getMinutes() - offsetMinutes);
        this._localDates.push(newDte);
        this.localTimes.push(newDte.getTime());
        return rawDateStr;
    };
    /**
     *
     * @protected
     * @returns {boolean} if should continue
     */
    RealEarthAnimate.prototype._loadLatest = function () {
        mapPopup_1.default.closePopup();
        if (this.localTimes.length > 0) {
            this._currentIndex = this.localTimes.length - 1;
            return true;
        }
        else {
            return false;
        }
    };
    /**
     *
     * @param {number} theTime - the time
     * @returns {boolean} true if new index, false if the same or below lowest value
     */
    RealEarthAnimate.prototype.setLayerTime = function (theTime) {
        this._currentTime = theTime;
        var newIndex;
        if (theTime < this.localTimes[0]) {
            return false;
        }
        else if (theTime > this.localTimes[this.localTimes.length - 1]) {
            newIndex = this.localTimes.length - 1;
        }
        for (var i = 0; i < this.localTimes.length; i++) {
            if (this.localTimes[i] >= theTime) {
                newIndex = i;
                break;
            }
        }
        if (newIndex == this._currentIndex) {
            return false;
        }
        else {
            this._currentIndex = newIndex;
            mapPopup_1.default.closePopup();
            return true;
        }
    };
    return RealEarthAnimate;
}());
exports.RealEarthAnimate = RealEarthAnimate;
nm.RealEarthAnimate = RealEarthAnimate;
exports.default = RealEarthAnimate;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVhbEVhcnRoQW5pbWF0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taXhpbi9SZWFsRWFydGhBbmltYXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7O0dBRUc7QUFDSCwyQ0FBc0M7QUFDdEMsa0RBQTZDO0FBRzdDLDBCQUE2QjtBQUU3QixJQUFNLEVBQUUsR0FBRyxpQkFBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBRzVCOzs7R0FHRztBQUNILElBQUksYUFBYSxHQUFHLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDLGlCQUFpQixFQUFFLENBQUM7QUFXckQ7OztHQUdHO0FBQ0g7SUFZSSwwQkFBWSxHQUE0QyxFQUFFLFlBQWtDO1FBQ3hGLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ2YsSUFBSSxDQUFDLFNBQVMsR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDO1FBQy9CLEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFBLENBQUM7WUFDZCxJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztRQUNyQyxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixJQUFJLENBQUMsWUFBWSxHQUFHLGNBQWtCLE1BQU0sQ0FBQyxDQUFBLENBQUMsQ0FBQztRQUNuRCxDQUFDO0lBQ0wsQ0FBQztJQUdEOztPQUVHO0lBQ0gsbUNBQVEsR0FBUjtRQUFBLGlCQXVCQztRQXJCRyxJQUFJLENBQUMsZUFBZSxHQUFHLEVBQUUsQ0FBQztRQUMxQixJQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQztRQUM1Qix1QkFBdUI7UUFDdkIsSUFBSSxDQUFDLFlBQVksR0FBRyxTQUFTLENBQUM7UUFDOUIsSUFBSSxDQUFDLGFBQWEsR0FBRyxTQUFTLENBQUM7UUFFL0IsQ0FBQyxD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Q2hCLENBQUM7SUFDTCxDQUFDO0lBQ0wsdUJBQUM7QUFBRCxDQUFDLEFBL0hELElBK0hDO0FBL0hZLDRDQUFnQjtBQWlJN0IsRUFBRSxDQUFDLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDO0FBQ3ZDLGtCQUFlLGdCQUFnQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENyZWF0ZWQgYnkgZ2F2b3JoZXMgb24gMTIvNC8yMDE1LlxyXG4gKi9cclxuaW1wb3J0IHByb3ZpZGUgZnJvbSAnLi4vdXRpbC9wcm92aWRlJztcclxuaW1wb3J0IG1hcFBvcHVwIGZyb20gJy4uL29sSGVscGVycy9tYXBQb3B1cCc7XHJcbmltcG9ydCBMYXllclJlYWxFYXJ0aFRpbGUgZnJvbSBcIi4uL2xheWVycy9MYXllclJlYWxFYXJ0aFRpbGVcIjtcclxuaW1wb3J0IHtMYXllclZlY3RvclJlYWxFYXJ0aH0gZnJvbSAnLi4vbGF5ZXJzL0xheWVyUmVhbEVhcnRoVmVjdG9yJ1xyXG5pbXBvcnQgJCA9IHJlcXVpcmUoJ2pxdWVyeScpO1xyXG5cclxuY29uc3Qgbm0gPSBwcm92aWRlKCdtaXhpbicpO1xyXG5cclxuXHJcbi8qKlxyXG4gKiBUaGUgR01UIG9mZnNldCB0aW1lIGluIG1pbnV0ZXNcclxuICogQHR5cGUge251bWJlcn1cclxuICovXHJcbmxldCBvZmZzZXRNaW51dGVzID0gKG5ldyBEYXRlKCkpLmdldFRpbWV6b25lT2Zmc2V0KCk7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElSZWFsRWFydGhBbmltYXRle1xyXG4gICAgc2V0TGF5ZXJUaW1lKHRoZVRpbWU6IG51bWJlcik6IGJvb2xlYW47XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgdGltZXNMb2FkZWRDYWxsYmFja3tcclxuICAgIChseXI/OiBMYXllclJlYWxFYXJ0aFRpbGV8TGF5ZXJWZWN0b3JSZWFsRWFydGgpOiB2b2lkO1xyXG59XHJcblxyXG5cclxuLyoqXHJcbiAqIE1peGluIHRvIGdldCB0aGUgcHJvZHVjdCB0aW1lc1xyXG4gKiBCZSBzdXJlIHRvIGNhbGwgZ2V0VGltZUluaXQgYWZ0ZXIgdGhlIG1peGluIGhhcyBiZWVuIGFwcGxpZWRcclxuICovXHJcbmV4cG9ydCBjbGFzcyBSZWFsRWFydGhBbmltYXRlIHtcclxuICAgIF9hbmltYXRlRW5hYmxlZDogYm9vbGVhbjtcclxuICAgIF9jdXJyZW50SW5kZXg6IG51bWJlcjtcclxuICAgIF9sb2NhbERhdGVzOiBEYXRlW107XHJcbiAgICBfcmF3RGF0ZVN0cmluZ3M6IHN0cmluZ1tdO1xyXG4gICAgX3Byb2R1Y3RzOiBzdHJpbmc7XHJcbiAgICBsb2FkQ2FsbGJhY2s6IHRpbWVzTG9hZGVkQ2FsbGJhY2s7XHJcbiAgICBsb2NhbFRpbWVzOiBudW1iZXJbXTtcclxuICAgIF9jdXJyZW50VGltZTogbnVtYmVyO1xyXG5cclxuICAgIGx5cjogTGF5ZXJSZWFsRWFydGhUaWxlfExheWVyVmVjdG9yUmVhbEVhcnRoO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGx5cjogTGF5ZXJSZWFsRWFydGhUaWxlfExheWVyVmVjdG9yUmVhbEVhcnRoLCBsb2FkQ2FsbGJhY2s/OiB0aW1lc0xvYWRlZENhbGxiYWNrKXtcclxuICAgICAgICB0aGlzLmx5ciA9IGx5cjtcclxuICAgICAgICB0aGlzLl9wcm9kdWN0cyA9IGx5ci5fcHJvZHVjdHM7XHJcbiAgICAgICAgaWYgKGxvYWRDYWxsYmFjayl7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZENhbGxiYWNrID0gbG9hZENhbGxiYWNrO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZENhbGxiYWNrID0gZnVuY3Rpb24oKTogdm9pZCB7cmV0dXJuO307XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICAvKipcclxuICAgICAqIENhbGwgdGhpcyBhZnRlciB0aGUgbWl4aW4gaGFzIGJlZW4gYXBwbGllZFxyXG4gICAgICovXHJcbiAgICB0aW1lSW5pdCgpIHtcclxuXHJcbiAgICAgICAgdGhpcy5fcmF3RGF0ZVN0cmluZ3MgPSBbXTtcclxuICAgICAgICB0aGlzLl9sb2NhbERhdGVzID0gW107XHJcbiAgICAgICAgdGhpcy5sb2NhbFRpbWVzID0gW107XHJcbiAgICAgICAgdGhpcy5fYW5pbWF0ZUVuYWJsZWQgPSB0cnVlO1xyXG4gICAgICAgIC8vIHRoaXMuX2xvYWRlZCA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5fY3VycmVudFRpbWUgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgdGhpcy5fY3VycmVudEluZGV4ID0gdW5kZWZpbmVkO1xyXG5cclxuICAgICAgICAkLmdldCgnaHR0cDovL3JlYWxlYXJ0aC5zc2VjLndpc2MuZWR1L2FwaS9wcm9kdWN0cycsIHtwcm9kdWN0czogdGhpcy5fcHJvZHVjdHN9LCAoZCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZC5sZW5ndGggPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5fcHJvZHVjdHN9IGxheWVyIG5vdCBhdmFpbGFibGUgb3IgZG9lcyBub3QgaGF2ZSB0aW1lc2ApO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBkID0gZFswXTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkWyd0aW1lcyddLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9sb2FkRGF0ZXMuY2FsbCh0aGlzLCBkWyd0aW1lcyddW2ldKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmxvYWRDYWxsYmFjay5jYWxsKHRoaXMubHlyLCB0aGlzLmx5cik7XHJcbiAgICAgICAgICAgIHRoaXMuX2xvYWRMYXRlc3QuY2FsbCh0aGlzKTtcclxuICAgICAgICB9LCAnanNvbicpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdpdmVuIHRoZSByYXcgdGltZSBzdHJpbmcsIGFkZCB0byB0aGUgYXJyYXlzIHRvIGtlZXAgdHJhY2sgb2YgZGF0ZXMgYW5kIGNhY2hlXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaW5TdHJpbmcgLSBpbnB1dCBzdHJpbmcgdG8gcGFyc2VcclxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IHRoZSBjb252ZXJ0ZWQgc3RyaW5nXHJcbiAgICAgKiBAcHJvdGVjdGVkXHJcbiAgICAgKi9cclxuICAgIF9sb2FkRGF0ZXMoaW5TdHJpbmc6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgICAgbGV0IHlyID0gaW5TdHJpbmcuc2xpY2UoMCwgNCk7XHJcbiAgICAgICAgbGV0IG1vbnRoID0gaW5TdHJpbmcuc2xpY2UoNCwgNik7XHJcbiAgICAgICAgbGV0IGQgPSBpblN0cmluZy5zbGljZSg2LCA4KTtcclxuICAgICAgICBsZXQgaHIgPSBpblN0cmluZy5zbGljZSg5LCAxMSk7XHJcbiAgICAgICAgbGV0IG1uID0gaW5TdHJpbmcuc2xpY2UoMTEsIDEzKTtcclxuICAgICAgICBsZXQgc2VjID0gaW5TdHJpbmcuc2xpY2UoMTMsIDE1KTtcclxuXHJcbiAgICAgICAgbGV0IHJhd0RhdGVTdHIgPSBpblN0cmluZy5yZXBsYWNlKCcuJywgJ18nKTtcclxuICAgICAgICB0aGlzLl9yYXdEYXRlU3RyaW5ncy5wdXNoKHJhd0RhdGVTdHIpO1xyXG5cclxuICAgICAgICBsZXQgZHRlU3RyID0gYCR7bW9udGh9LyR7ZH0vJHt5cn0gJHtocn06JHttbn06JHtzZWN9YDtcclxuICAgICAgICBsZXQgbmV3RHRlID0gbmV3IERhdGUoZHRlU3RyKTtcclxuICAgICAgICBuZXdEdGUuc2V0TWludXRlcyhuZXdEdGUuZ2V0TWludXRlcygpIC0gb2Zmc2V0TWludXRlcyk7XHJcbiAgICAgICAgdGhpcy5fbG9jYWxEYXRlcy5wdXNoKG5ld0R0ZSk7XHJcbiAgICAgICAgdGhpcy5sb2NhbFRpbWVzLnB1c2gobmV3RHRlLmdldFRpbWUoKSk7XHJcblxyXG4gICAgICAgIHJldHVybiByYXdEYXRlU3RyO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICpcclxuICAgICAqIEBwcm90ZWN0ZWRcclxuICAgICAqIEByZXR1cm5zIHtib29sZWFufSBpZiBzaG91bGQgY29udGludWVcclxuICAgICAqL1xyXG4gICAgX2xvYWRMYXRlc3QoKXtcclxuICAgICAgICBtYXBQb3B1cC5jbG9zZVBvcHVwKCk7XHJcbiAgICAgICAgaWYgKHRoaXMubG9jYWxUaW1lcy5sZW5ndGggPiAwKXtcclxuICAgICAgICAgICAgdGhpcy5fY3VycmVudEluZGV4ID0gdGhpcy5sb2NhbFRpbWVzLmxlbmd0aCAtMTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKlxyXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IHRoZVRpbWUgLSB0aGUgdGltZVxyXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59IHRydWUgaWYgbmV3IGluZGV4LCBmYWxzZSBpZiB0aGUgc2FtZSBvciBiZWxvdyBsb3dlc3QgdmFsdWVcclxuICAgICAqL1xyXG4gICAgc2V0TGF5ZXJUaW1lKHRoZVRpbWU6IG51bWJlcik6IGJvb2xlYW57XHJcblxyXG4gICAgICAgIHRoaXMuX2N1cnJlbnRUaW1lID0gdGhlVGltZTtcclxuXHJcbiAgICAgICAgbGV0IG5ld0luZGV4O1xyXG5cclxuICAgICAgICBpZiAodGhlVGltZSA8IHRoaXMubG9jYWxUaW1lc1swXSl7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9IGVsc2UgaWYgKHRoZVRpbWUgPiB0aGlzLmxvY2FsVGltZXNbdGhpcy5sb2NhbFRpbWVzLmxlbmd0aCAtIDFdKXtcclxuICAgICAgICAgICAgbmV3SW5kZXggPSB0aGlzLmxvY2FsVGltZXMubGVuZ3RoIC0gMTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5sb2NhbFRpbWVzLmxlbmd0aDsgaSsrKXtcclxuICAgICAgICAgICAgaWYgKHRoaXMubG9jYWxUaW1lc1tpXSA+PSB0aGVUaW1lKXtcclxuICAgICAgICAgICAgICAgIG5ld0luZGV4ID0gaTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAobmV3SW5kZXggPT0gdGhpcy5fY3VycmVudEluZGV4KXtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnRJbmRleCA9IG5ld0luZGV4O1xyXG4gICAgICAgICAgICBtYXBQb3B1cC5jbG9zZVBvcHVwKCk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbm5tLlJlYWxFYXJ0aEFuaW1hdGUgPSBSZWFsRWFydGhBbmltYXRlO1xyXG5leHBvcnQgZGVmYXVsdCBSZWFsRWFydGhBbmltYXRlO1xyXG5cclxuIl19