"use strict";
/**
 * Created by gavorhes on 12/4/2015.
 */
var provide_1 = require("../util/provide");
var mapPopup_1 = require("../olHelpers/mapPopup");
var $ = require("jquery");
var nm = provide_1.default('mixin');
/**
 * The GMT offset time in minutes
 * @type {number}
 */
var offsetMinutes = (new Date()).getTimezoneOffset();
/**
 * Mixin to get the product times
 * Be sure to call getTimeInit after the mixin has been applied
 */
var RealEarthAnimate = (function () {
    function RealEarthAnimate(lyr, loadCallback) {
        this.lyr = lyr;
        this._products = lyr._products;
        if (loadCallback) {
            this.loadCallback = loadCallback;
        }
        else {
            this.loadCallback = function () { return; };
        }
    }
    /**
     * Call this after the mixin has been applied
     */
    RealEarthAnimate.prototype.timeInit = function () {
        var _this = this;
        this._rawDateStrings = [];
        this._localDates = [];
        this.localTimes = [];
        this._animateEnabled = true;
        // this._loaded = true;
        this._currentTime = undefined;
        this._currentIndex = undefined;
        $.get('http://realearth.ssec.wisc.edu/api/products', { products: this._products }, function (d) {
            if (d.length == 0) {
                console.log(_this._products + " layer not available or does not have times");
                return;
            }
            d = d[0];
            for (var i = 0; i < d['times'].length; i++) {
                _this._loadDates.call(_this, d['times'][i]);
            }
            _this.loadCallback.call(_this.lyr, _this.lyr);
            _this._loadLatest.call(_this);
        }, 'json');
    };
    /**
     * Given the raw time string, add to the arrays to keep track of dates and cache
     * @param {string} inString - input string to parse
     * @returns {string} the converted string
     * @protected
     */
    RealEarthAnimate.prototype._loadDates = function (inString) {
        var yr = inString.slice(0, 4);
        var month = inString.slice(4, 6);
        var d = inString.slice(6, 8);
        var hr = inString.slice(9, 11);
        var mn = inString.slice(11, 13);
        var sec = inString.slice(13, 15);
        var rawDateStr = inString.replace('.', '_');
        this._rawDateStrings.push(rawDateStr);
        var dteStr = month + "/" + d + "/" + yr + " " + hr + ":" + mn + ":" + sec;
        var newDte = new Date(dteStr);
        newDte.setMinutes(newDte.getMinutes() - offsetMinutes);
        this._localDates.push(newDte);
        this.localTimes.push(newDte.getTime());
        return rawDateStr;
    };
    /**
     *
     * @protected
     * @returns {boolean} if should continue
     */
    RealEarthAnimate.prototype._loadLatest = function () {
        mapPopup_1.default.closePopup();
        if (this.localTimes.length > 0) {
            this._currentIndex = this.localTimes.length - 1;
            return true;
        }
        else {
            return false;
        }
    };
    /**
     *
     * @param {number} theTime - the time
     * @returns {boolean} true if new index, false if the same or below lowest value
     */
    RealEarthAnimate.prototype.setLayerTime = function (theTime) {
        this._currentTime = theTime;
        var newIndex;
        if (theTime < this.localTimes[0]) {
            return false;
        }
        else if (theTime > this.localTimes[this.localTimes.length - 1]) {
            newIndex = this.localTimes.length - 1;
        }
        for (var i = 0; i < this.localTimes.length; i++) {
            if (this.localTimes[i] >= theTime) {
                newIndex = i;
                break;
            }
        }
        if (newIndex == this._currentIndex) {
            return false;
        }
        else {
            this._currentIndex = newIndex;
            mapPopup_1.default.closePopup();
            return true;
        }
    };
    return RealEarthAnimate;
}());
exports.RealEarthAnimate = RealEarthAnimate;
nm.RealEarthAnimate = RealEarthAnimate;
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = RealEarthAnimate;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVhbEVhcnRoQW5pbWF0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taXhpbi9SZWFsRWFydGhBbmltYXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRztBQUNILDJDQUFzQztBQUN0QyxrREFBNkM7QUFHN0MsMEJBQTZCO0FBRTdCLElBQU0sRUFBRSxHQUFHLGlCQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7QUFHNUI7OztHQUdHO0FBQ0gsSUFBSSxhQUFhLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztBQVdyRDs7O0dBR0c7QUFDSDtJQVlJLDBCQUFZLEdBQTRDLEVBQUUsWUFBa0M7UUFDeEYsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFDZixJQUFJLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUM7UUFDL0IsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUEsQ0FBQztZQUNkLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ3JDLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLElBQUksQ0FBQyxZQUFZLEdBQUcsY0FBa0IsTUFBTSxDQUFDLENBQUEsQ0FBQyxDQUFDO1FBQ25ELENBQUM7SUFDTCxDQUFDO0lBR0Q7O09BRUc7SUFDSCxtQ0FBUSxHQUFSO1FBQUEsaUJBdUJDO1FBckJHLElBQUksQ0FBQyxlQUFlLEdBQUcsRUFBRSxDQUFDO1FBQzFCLElBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO1FBQzVCLHVCQUF1QjtRQUN2QixJQUFJLENBQUMsWUFBWSxHQUFHLFNBQVMsQ0FBQztRQUM5QixJQUFJLENBQUMsYUFBYSxHQUFHLFNBQVMsQ0FBQztRQUUvQixDQUFDLENB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aEIsQ0FBQztJQUNMLENBQUM7SUFDTCx1QkFBQztBQUFELENBQUMsQUEvSEQsSUErSEM7QUEvSFksNENBQWdCO0FBaUk3QixFQUFFLENBQUMsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUM7O0FBQ3ZDLGtCQUFlLGdCQUFnQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENyZWF0ZWQgYnkgZ2F2b3JoZXMgb24gMTIvNC8yMDE1LlxyXG4gKi9cclxuaW1wb3J0IHByb3ZpZGUgZnJvbSAnLi4vdXRpbC9wcm92aWRlJztcclxuaW1wb3J0IG1hcFBvcHVwIGZyb20gJy4uL29sSGVscGVycy9tYXBQb3B1cCc7XHJcbmltcG9ydCBMYXllclJlYWxFYXJ0aFRpbGUgZnJvbSBcIi4uL2xheWVycy9MYXllclJlYWxFYXJ0aFRpbGVcIjtcclxuaW1wb3J0IHtMYXllclZlY3RvclJlYWxFYXJ0aH0gZnJvbSAnLi4vbGF5ZXJzL0xheWVyUmVhbEVhcnRoVmVjdG9yJ1xyXG5pbXBvcnQgJCA9IHJlcXVpcmUoJ2pxdWVyeScpO1xyXG5cclxuY29uc3Qgbm0gPSBwcm92aWRlKCdtaXhpbicpO1xyXG5cclxuXHJcbi8qKlxyXG4gKiBUaGUgR01UIG9mZnNldCB0aW1lIGluIG1pbnV0ZXNcclxuICogQHR5cGUge251bWJlcn1cclxuICovXHJcbmxldCBvZmZzZXRNaW51dGVzID0gKG5ldyBEYXRlKCkpLmdldFRpbWV6b25lT2Zmc2V0KCk7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElSZWFsRWFydGhBbmltYXRle1xyXG4gICAgc2V0TGF5ZXJUaW1lKHRoZVRpbWU6IG51bWJlcik6IGJvb2xlYW47XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgdGltZXNMb2FkZWRDYWxsYmFja3tcclxuICAgIChseXI/OiBMYXllclJlYWxFYXJ0aFRpbGV8TGF5ZXJWZWN0b3JSZWFsRWFydGgpOiB2b2lkO1xyXG59XHJcblxyXG5cclxuLyoqXHJcbiAqIE1peGluIHRvIGdldCB0aGUgcHJvZHVjdCB0aW1lc1xyXG4gKiBCZSBzdXJlIHRvIGNhbGwgZ2V0VGltZUluaXQgYWZ0ZXIgdGhlIG1peGluIGhhcyBiZWVuIGFwcGxpZWRcclxuICovXHJcbmV4cG9ydCBjbGFzcyBSZWFsRWFydGhBbmltYXRlIHtcclxuICAgIF9hbmltYXRlRW5hYmxlZDogYm9vbGVhbjtcclxuICAgIF9jdXJyZW50SW5kZXg6IG51bWJlcjtcclxuICAgIF9sb2NhbERhdGVzOiBEYXRlW107XHJcbiAgICBfcmF3RGF0ZVN0cmluZ3M6IHN0cmluZ1tdO1xyXG4gICAgX3Byb2R1Y3RzOiBzdHJpbmc7XHJcbiAgICBsb2FkQ2FsbGJhY2s6IHRpbWVzTG9hZGVkQ2FsbGJhY2s7XHJcbiAgICBsb2NhbFRpbWVzOiBudW1iZXJbXTtcclxuICAgIF9jdXJyZW50VGltZTogbnVtYmVyO1xyXG5cclxuICAgIGx5cjogTGF5ZXJSZWFsRWFydGhUaWxlfExheWVyVmVjdG9yUmVhbEVhcnRoO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGx5cjogTGF5ZXJSZWFsRWFydGhUaWxlfExheWVyVmVjdG9yUmVhbEVhcnRoLCBsb2FkQ2FsbGJhY2s/OiB0aW1lc0xvYWRlZENhbGxiYWNrKXtcclxuICAgICAgICB0aGlzLmx5ciA9IGx5cjtcclxuICAgICAgICB0aGlzLl9wcm9kdWN0cyA9IGx5ci5fcHJvZHVjdHM7XHJcbiAgICAgICAgaWYgKGxvYWRDYWxsYmFjayl7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZENhbGxiYWNrID0gbG9hZENhbGxiYWNrO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZENhbGxiYWNrID0gZnVuY3Rpb24oKTogdm9pZCB7cmV0dXJuO307XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICAvKipcclxuICAgICAqIENhbGwgdGhpcyBhZnRlciB0aGUgbWl4aW4gaGFzIGJlZW4gYXBwbGllZFxyXG4gICAgICovXHJcbiAgICB0aW1lSW5pdCgpIHtcclxuXHJcbiAgICAgICAgdGhpcy5fcmF3RGF0ZVN0cmluZ3MgPSBbXTtcclxuICAgICAgICB0aGlzLl9sb2NhbERhdGVzID0gW107XHJcbiAgICAgICAgdGhpcy5sb2NhbFRpbWVzID0gW107XHJcbiAgICAgICAgdGhpcy5fYW5pbWF0ZUVuYWJsZWQgPSB0cnVlO1xyXG4gICAgICAgIC8vIHRoaXMuX2xvYWRlZCA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5fY3VycmVudFRpbWUgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgdGhpcy5fY3VycmVudEluZGV4ID0gdW5kZWZpbmVkO1xyXG5cclxuICAgICAgICAkLmdldCgnaHR0cDovL3JlYWxlYXJ0aC5zc2VjLndpc2MuZWR1L2FwaS9wcm9kdWN0cycsIHtwcm9kdWN0czogdGhpcy5fcHJvZHVjdHN9LCAoZCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZC5sZW5ndGggPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5fcHJvZHVjdHN9IGxheWVyIG5vdCBhdmFpbGFibGUgb3IgZG9lcyBub3QgaGF2ZSB0aW1lc2ApO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBkID0gZFswXTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkWyd0aW1lcyddLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9sb2FkRGF0ZXMuY2FsbCh0aGlzLCBkWyd0aW1lcyddW2ldKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmxvYWRDYWxsYmFjay5jYWxsKHRoaXMubHlyLCB0aGlzLmx5cik7XHJcbiAgICAgICAgICAgIHRoaXMuX2xvYWRMYXRlc3QuY2FsbCh0aGlzKTtcclxuICAgICAgICB9LCAnanNvbicpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdpdmVuIHRoZSByYXcgdGltZSBzdHJpbmcsIGFkZCB0byB0aGUgYXJyYXlzIHRvIGtlZXAgdHJhY2sgb2YgZGF0ZXMgYW5kIGNhY2hlXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaW5TdHJpbmcgLSBpbnB1dCBzdHJpbmcgdG8gcGFyc2VcclxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IHRoZSBjb252ZXJ0ZWQgc3RyaW5nXHJcbiAgICAgKiBAcHJvdGVjdGVkXHJcbiAgICAgKi9cclxuICAgIF9sb2FkRGF0ZXMoaW5TdHJpbmc6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgICAgbGV0IHlyID0gaW5TdHJpbmcuc2xpY2UoMCwgNCk7XHJcbiAgICAgICAgbGV0IG1vbnRoID0gaW5TdHJpbmcuc2xpY2UoNCwgNik7XHJcbiAgICAgICAgbGV0IGQgPSBpblN0cmluZy5zbGljZSg2LCA4KTtcclxuICAgICAgICBsZXQgaHIgPSBpblN0cmluZy5zbGljZSg5LCAxMSk7XHJcbiAgICAgICAgbGV0IG1uID0gaW5TdHJpbmcuc2xpY2UoMTEsIDEzKTtcclxuICAgICAgICBsZXQgc2VjID0gaW5TdHJpbmcuc2xpY2UoMTMsIDE1KTtcclxuXHJcbiAgICAgICAgbGV0IHJhd0RhdGVTdHIgPSBpblN0cmluZy5yZXBsYWNlKCcuJywgJ18nKTtcclxuICAgICAgICB0aGlzLl9yYXdEYXRlU3RyaW5ncy5wdXNoKHJhd0RhdGVTdHIpO1xyXG5cclxuICAgICAgICBsZXQgZHRlU3RyID0gYCR7bW9udGh9LyR7ZH0vJHt5cn0gJHtocn06JHttbn06JHtzZWN9YDtcclxuICAgICAgICBsZXQgbmV3RHRlID0gbmV3IERhdGUoZHRlU3RyKTtcclxuICAgICAgICBuZXdEdGUuc2V0TWludXRlcyhuZXdEdGUuZ2V0TWludXRlcygpIC0gb2Zmc2V0TWludXRlcyk7XHJcbiAgICAgICAgdGhpcy5fbG9jYWxEYXRlcy5wdXNoKG5ld0R0ZSk7XHJcbiAgICAgICAgdGhpcy5sb2NhbFRpbWVzLnB1c2gobmV3RHRlLmdldFRpbWUoKSk7XHJcblxyXG4gICAgICAgIHJldHVybiByYXdEYXRlU3RyO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICpcclxuICAgICAqIEBwcm90ZWN0ZWRcclxuICAgICAqIEByZXR1cm5zIHtib29sZWFufSBpZiBzaG91bGQgY29udGludWVcclxuICAgICAqL1xyXG4gICAgX2xvYWRMYXRlc3QoKXtcclxuICAgICAgICBtYXBQb3B1cC5jbG9zZVBvcHVwKCk7XHJcbiAgICAgICAgaWYgKHRoaXMubG9jYWxUaW1lcy5sZW5ndGggPiAwKXtcclxuICAgICAgICAgICAgdGhpcy5fY3VycmVudEluZGV4ID0gdGhpcy5sb2NhbFRpbWVzLmxlbmd0aCAtMTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKlxyXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IHRoZVRpbWUgLSB0aGUgdGltZVxyXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59IHRydWUgaWYgbmV3IGluZGV4LCBmYWxzZSBpZiB0aGUgc2FtZSBvciBiZWxvdyBsb3dlc3QgdmFsdWVcclxuICAgICAqL1xyXG4gICAgc2V0TGF5ZXJUaW1lKHRoZVRpbWU6IG51bWJlcik6IGJvb2xlYW57XHJcblxyXG4gICAgICAgIHRoaXMuX2N1cnJlbnRUaW1lID0gdGhlVGltZTtcclxuXHJcbiAgICAgICAgbGV0IG5ld0luZGV4O1xyXG5cclxuICAgICAgICBpZiAodGhlVGltZSA8IHRoaXMubG9jYWxUaW1lc1swXSl7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9IGVsc2UgaWYgKHRoZVRpbWUgPiB0aGlzLmxvY2FsVGltZXNbdGhpcy5sb2NhbFRpbWVzLmxlbmd0aCAtIDFdKXtcclxuICAgICAgICAgICAgbmV3SW5kZXggPSB0aGlzLmxvY2FsVGltZXMubGVuZ3RoIC0gMTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5sb2NhbFRpbWVzLmxlbmd0aDsgaSsrKXtcclxuICAgICAgICAgICAgaWYgKHRoaXMubG9jYWxUaW1lc1tpXSA+PSB0aGVUaW1lKXtcclxuICAgICAgICAgICAgICAgIG5ld0luZGV4ID0gaTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAobmV3SW5kZXggPT0gdGhpcy5fY3VycmVudEluZGV4KXtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnRJbmRleCA9IG5ld0luZGV4O1xyXG4gICAgICAgICAgICBtYXBQb3B1cC5jbG9zZVBvcHVwKCk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbm5tLlJlYWxFYXJ0aEFuaW1hdGUgPSBSZWFsRWFydGhBbmltYXRlO1xyXG5leHBvcnQgZGVmYXVsdCBSZWFsRWFydGhBbmltYXRlO1xyXG5cclxuIl19